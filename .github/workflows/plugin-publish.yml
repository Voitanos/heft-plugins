name: Publish NPM Package

defaults:
  run:
    shell: bash

on:
  push:
    tags:
      - 'heft-*-plugin@v*.*.*'
      - 'telemetry-core@v*.*.*'

env:
  NODE_VERSION: '22'
  RUSH_VERSION: '5.162.0'
  # Azure AppInsights connection string for all plugins
  #   HEFT_PLUGINS_APP_INSIGHTS_CONNECTION_STRING: <repo.variable>

permissions:
  contents: write
  # used for npmjs.org trusted publishers
  #   - https://docs.npmjs.com/trusted-publishers
  #   - https://docs.github.com/en/actions/concepts/security/openid-connect
  id-token: write

jobs:
  ######################################################################
  # ensure build completes without errors & tests pass
  ######################################################################
  validate:
    name: Validate Build
    runs-on: ubuntu-latest
    steps:
      ######################################################################
      # checkout codebase
      ######################################################################
      - name: Checkout repo codebase
        uses: actions/checkout@v4

      ######################################################################
      # configure to use Node.js version
      ######################################################################
      - name: ðŸ”§  Setup Node v${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      ######################################################################
      # install Rush
      ######################################################################
      - name: âš™ï¸  Install Rush v${{ env.RUSH_VERSION }}
        run: npm install -g @microsoft/rush@${{ env.RUSH_VERSION }}

      ######################################################################
      # install dependencies
      ######################################################################
      - name: â¬‡ï¸  Install dependencies
        run: rush update

      ######################################################################
      # build all packages
      ######################################################################
      - name: ðŸ™  Build all packages
        run: rush rebuild --verbose

      ######################################################################
      # run tests
      ######################################################################
      - name: ðŸ§ª  Run all tests
        run: rush test

  ######################################################################
  # publish package to npmjs.org
  ######################################################################
  publish:
    name: Publish to npmjs.org
    needs: [validate]
    runs-on: ubuntu-latest
    # environment: production  # Temporarily disabled for testing
    steps:
      ######################################################################
      # checkout codebase
      ######################################################################
      - name: Checkout repo codebase
        uses: actions/checkout@v4

      ######################################################################
      # configure to use Node.js version
      ######################################################################
      - name: ðŸ”§  Setup Node v${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      ######################################################################
      # update npm to v11.5.1+ (required for npmjs.org trusted publishing)
      ######################################################################
      - name: âš™ï¸  Update npm (v11.5.1+)
        run: npm install -g npm@latest

      ######################################################################
      # install Rush
      ######################################################################
      - name: âš™ï¸  Install Rush v${{ env.RUSH_VERSION }}
        run: npm install -g @microsoft/rush@${{ env.RUSH_VERSION }}

      ######################################################################
      # install dependencies
      ######################################################################
      - name: â¬‡ï¸  Install dependencies
        run: rush update

      ######################################################################
      # build all packages
      ######################################################################
      - name: ðŸ™  Build all packages
        run: rush rebuild --verbose

      ######################################################################
      # get details about package:
      #   - name
      #   - version
      #   - distro tag: @latest | @next
      ######################################################################
      - name: ðŸª  Extract package name, version, and determine dist-tag
        id: version
        run: |
          # Extract from tag format: heft-stylelint-plugin@v0.1.0 or telemetry-core@v0.1.0
          FULL_TAG=${GITHUB_REF#refs/tags/}
          PACKAGE_SHORT_NAME=${FULL_TAG%@v*}
          VERSION=${FULL_TAG#*@v}

          echo "package_short_name=$PACKAGE_SHORT_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Map package short name to folder path
          # Plugins live in heft-plugins/, libraries live in packages/
          case $PACKAGE_SHORT_NAME in
            heft-*-plugin)
              PACKAGE_PATH="heft-plugins/${PACKAGE_SHORT_NAME}"
              ;;
            telemetry-core)
              PACKAGE_PATH="packages/${PACKAGE_SHORT_NAME}"
              ;;
            *)
              echo "Error: Unknown package '${PACKAGE_SHORT_NAME}'"
              exit 1
              ;;
          esac

          echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
          echo "Publishing package from directory: $PACKAGE_PATH"
          echo "Version: $VERSION"

          # Determine NPM dist-tag based on version format
          if [[ $VERSION =~ -beta\. ]]; then
            echo "dist_tag=next" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          elif [[ $VERSION =~ -rc\. ]]; then
            echo "dist_tag=next" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          elif [[ $VERSION =~ -alpha\. ]]; then
            echo "dist_tag=next" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "dist_tag=latest" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      ######################################################################
      # get package full name from package.json
      ######################################################################
      - name: ðŸª  Get package full name from package.json
        id: package
        run: |
          cd ${{ steps.version.outputs.package_path }}
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "Full package name: $PACKAGE_NAME"

      ######################################################################
      # inject Azure Application Insights connection string into
      #   @voitanos/heft-plugins-telemetry-core package with utility script
      ######################################################################
      - name: ðŸ’‰  Inject AppInsights connection string into @voitanos/heft-plugins-telemetry-core
        run: node packages/telemetry-core/scripts/inject-connection-string.js
        env:
          HEFT_PLUGINS_APP_INSIGHTS_CONNECTION_STRING: ${{ vars.HEFT_PLUGINS_APP_INSIGHTS_CONNECTION_STRING }}

      ######################################################################
      # gating function check - ensure AppInsights connection string injected
      #   - if not, fail the job... must be valid
      ######################################################################
      - name: ðŸ§ª  Verify Az AppInsights connection string injected
        run: |
          # Check that the placeholder was replaced in the built telemetry-core package
          TELEMETRY_FILE="packages/telemetry-core/lib/TelemetryClient.js"

          if [ ! -f "$TELEMETRY_FILE" ]; then
            echo "Error: Built file $TELEMETRY_FILE not found"
            exit 1
          fi

          # Check if placeholder still exists (it shouldn't after injection)
          if grep -q '__HEFT_PLUGINS_APP_INSIGHTS_CONNECTION_STRING__' "$TELEMETRY_FILE"; then
            echo "Error: Connection string placeholder was not replaced!"
            echo "The HEFT_PLUGINS_APP_INSIGHTS_CONNECTION_STRING variable may not be set in GitHub repository variables."
            exit 1
          fi

          # Verify the connection string looks valid (contains InstrumentationKey or IngestionEndpoint)
          if ! grep -qE '(InstrumentationKey=|IngestionEndpoint=)' "$TELEMETRY_FILE"; then
            echo "Error: Injected connection string does not appear to be a valid App Insights connection string"
            echo "Expected to find 'InstrumentationKey=' or 'IngestionEndpoint=' in the built file"
            exit 1
          fi

          echo "Connection string successfully injected and validated"

      ######################################################################
      # configure npm for OIDC authentication
      #   > https://docs.npmjs.com/trusted-publishers
      ######################################################################
      - name: ðŸ”§  Configure npm for OIDC authentication
        run: |
          npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true
          npm config delete always-auth 2>/dev/null || true
          npm config delete //registry.npmjs.org/:always-auth 2>/dev/null || true

      ######################################################################
      # publish package to npmjs.org based on tag that triggered workflow
      ######################################################################
      - name: ðŸš€  Publish specific package to NPM with provenance
        run: |
          cd ${{ steps.version.outputs.package_path }}
          npm publish --access public --tag ${{ steps.version.outputs.dist_tag }} --provenance

      ######################################################################
      # publish package to npmjs.org based on tag that triggered workflow
      ######################################################################
      - name: ðŸ“¦  Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.package.outputs.name }}@${{ steps.version.outputs.version }}
          generate_release_notes: true
          prerelease: ${{ steps.version.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
